package com.cropDetails.Service;

import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.cropDetails.Exceptions.CropAlreadyExistException;
import com.cropDetails.Exceptions.NoCropFoundException;
import com.cropDetails.Exceptions.NoCropRegisteredException;
import com.cropDetails.Exceptions.SubscriptionAlreadyExistsException;
import com.cropDetails.Model.Crop;
import com.cropDetails.Model.CropSubscription;
import com.cropDetails.Repository.CropRepository;
import com.cropDetails.Repository.CropSubscriptionRepository;

@Service
public class CropServImpl implements ICropService {
	

	@Autowired
	CropRepository repo;
	@Autowired
	CropSubscriptionRepository  subscriptionRepository;
	@Override
	public List<Crop> viewAllCrops() throws NoCropFoundException{
		List<Crop> l=repo.findAll();
		if(l.isEmpty()) {
			throw new NoCropFoundException();
		}
		return l;
	}

	@Override
	public Optional<Crop> addCrop(Crop crop)throws CropAlreadyExistException {
		Optional<Crop> c=repo.findById(crop.getCId());
		if(c.isPresent()) {
			throw new CropAlreadyExistException();
		}
		Crop cr=repo.save(crop);
		return Optional.of(cr);
	}

	@Override
	public Boolean deleteCropById(int id) throws NoCropRegisteredException{
		Optional<Crop> c=repo.findById(id);
		if(c.isEmpty()) {
			throw new NoCropRegisteredException();
		}
		repo.deleteById(id);
		return true;
	}

	@Override
	public Optional<Crop> updateCrop(Crop crop)throws NoCropRegisteredException {
		Optional<Crop> c=repo.findById(crop.getCId());
		if(c.isEmpty()) {
			throw new NoCropRegisteredException();
		}
		Crop cr=repo.save(crop);
		return Optional.of(cr);
	}

	@Override
	public Optional<Crop> getCropById(int id)throws NoCropRegisteredException {
		Optional<Crop> c=repo.findById(id);
		if(c.isEmpty()) {
			throw new NoCropRegisteredException();
		}
		return c;
	}

	@Override
	public Optional<Crop> getCropByName(String name) throws NoCropRegisteredException {
		Optional<Crop>c=repo.findByName(name);
		if(c.isEmpty()) {
			throw new NoCropRegisteredException();
		}
		return c;
	}

	@Override
	public Optional<Crop> getCropByType(String type) throws NoCropRegisteredException {
		Optional<Crop>c=repo.findByType(type);
		if(c.isEmpty()) {
			throw new NoCropRegisteredException();
		}
		return c;
	}

	public void subscribeToCrop(int uId, String cropType) throws SubscriptionAlreadyExistsException {
        // Check if the subscription already exists
        Optional<CropSubscription> existingSubscription = subscriptionRepository.findByUIdAndCropType(uId, cropType);
        if (existingSubscription.isPresent()) {
            throw new SubscriptionAlreadyExistsException();
        }

        // Create a new subscription
        CropSubscription newSubscription = new CropSubscription();
        newSubscription.setUId(uId);
        newSubscription.setCropType(cropType);

        // Save the subscription to the database
        subscriptionRepository.save(newSubscription);
    }	

}
